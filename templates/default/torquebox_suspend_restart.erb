#!<%= node[:rbenv][:root_path] %>/shims/ruby

require "net/http"

puts "Pausing requests..."
response = Net::HTTP.get_response(URI.parse("http://localhost:<%= node[:nginx_intermission][:port] %>/_intermission/enable?app_name=torquebox"))
response = Net::HTTP.get_response(URI.parse("http://localhost:<%= node[:nginx_intermission][:port] %>/_intermission/status?app_name=torquebox"))
raise "Intermission does not appear to be paused as expected" unless(response.body =~ /Pause enabled/i)

puts "Waiting 2 seconds for active requests to complete..."
sleep 2

system("/etc/init.d/torquebox stop")
system("/etc/init.d/torquebox start")

print "Waiting for torquebox to start..."
while(true)
  still_deploying_markers = Dir.glob("<%= node[:torquebox][:conf_dir] %>/deployments/*.isdeploying")
  break if(still_deploying_markers.empty?)

  print "."
  sleep 0.5
end

puts "\nResuming requests..."
Net::HTTP.get_response(URI.parse("http://localhost:<%= node[:nginx_intermission][:port] %>/_intermission/disable?app_name=torquebox"))

response = Net::HTTP.get_response(URI.parse("http://localhost:<%= node[:nginx_intermission][:port] %>/_intermission/status?app_name=torquebox"))
raise "Intermission does not appear to be unpaused as expected" unless(response.body =~ /Pause disabled/i)
